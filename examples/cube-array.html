<!doctype html>
<html lang="de">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>cube-array</title>
        <style type="text/css">
            #container {
                position: fixed;
                top: 0px;
                left: 0px;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
            #fps {
                position: fixed;
                top: 10px;
                left: 10px;
                color: #FFFFFF;
                z-index: 10;
            }
        </style>
    </head>

    <body>
        <div id="container"></div>
        <p id="fps"></p>
        <script src="./assets/massiv-3d.umd.js"></script>
        <script src="./assets/cube-geometry.js"></script>
        <script type="text/javascript">
            (async () => {
                const fpsDisplay = document.getElementById('fps');
                const domNode = document.getElementById('container');
                const renderer = new MASSIV.WebGL2Renderer(domNode);

                const aspect = domNode.clientWidth / domNode.clientHeight;
                const camera = new MASSIV.PerspectiveCamera({ fov: 45, aspect, near: 0.1, far: 1000 });
                camera.translate(0, 30, 60);
                camera.lookAt(0, 0, 0);

                const { vertices, normals, uvs, indices } = cubeGeometry;

                const mesh = new MASSIV.Mesh({
                    geometry: new MASSIV.Geometry({ vertices, normals, uvs }),
                    material: new MASSIV.StandardMaterial({ indices }),
                });

                const cubeSize = 15;
                const cubeArray = [];

                for (let x = -15; x <= cubeSize; x += 3) {
                    for (let y = -15; y <= cubeSize; y += 3) {
                        for (let z = -15; z <= cubeSize; z += 3) {
                            const clone = mesh.clone();
                            clone.translate(x, y, z);
                            cubeArray.push(clone);
                        }
                    }
                }

                const light = new MASSIV.DirectionalLight({ direction: new MASSIV.Vec3(30, 30, 30) });

                const scene = new MASSIV.Scene();
                scene.addChildren([camera, light, ...cubeArray]);
                scene.setActiveCamera(camera);

                window.addEventListener('resize', () => {
                    const aspect = domNode.clientWidth / domNode.clientHeight;
                    camera.updateProjectionMatrix({ fov: 45, aspect, near: 0.1, far: 1000 });
                    renderer.resize();
                    renderer.render(scene);
                });

                let then = 0, oneSecond = Date.now() + 1000, fps = 0, rotation = 30;
                const getRandomRotation = () => Math.round(Math.random() * 45);

                const update = (now) => {
                    requestAnimationFrame(update);

                    now *= 0.001;
                    const delta = now - then;
                    then = now;
                    fps++;

                    scene.rotate(0, rotation * delta, 0);
                    cubeArray.forEach(cube => cube.rotate(getRandomRotation() * delta, getRandomRotation() * delta, getRandomRotation() * delta));
                    renderer.render(scene);

                    const currentTime = Date.now();
                    if (currentTime >= oneSecond) {
                        const w = domNode.clientWidth, h = domNode.clientHeight;
                        fpsDisplay.textContent = `FPS: ${fps} | Screen: ${w}/${h}`;
                        fps = 0;
                        oneSecond = currentTime + 1000;
                    }
                };

                requestAnimationFrame(update);
            })();
        </script>
    </body>
</html>
