<!doctype html>
<html lang="de">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>parent-child-transform</title>
        <style type="text/css">
            #container {
                position: fixed;
                top: 0px;
                left: 0px;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
            #fps {
                position: fixed;
                top: 10px;
                left: 10px;
                color: #FFFFFF;
                z-index: 10;
            }
        </style>
    </head>

    <body>
        <div id="container"></div>
        <p id="fps"></p>
        <script src="massiv-3d.umd.js"></script>
        <script type="text/javascript">
            (async () => {
                const domNode = document.getElementById('container');
                const fpsCounter = document.getElementById('fps');

                const renderer = new MASSIV.WebGL2Renderer(domNode);

                const camera = new MASSIV.PerspectiveCamera(45, domNode.clientWidth / domNode.clientHeight, 0.1, 1000);
                camera.translate(0, 10, -10);
                camera.lookAt(0, 0, 0);

                const geometry = new MASSIV.Geometry();
                geometry.setVertices([0, 0.5, 0, 0.5, -0.5, 0, -0.5, -0.5, 0]);
                geometry.setVertexColors([
                    1, 0, 0, 1,
                    0, 1, 0, 1,
                    0, 0, 1, 1,
                ]);

                const material = new MASSIV.VertexColorMaterial();
                material.setIndices([0, 1, 2]);

                const rootNode = new MASSIV.Mesh(geometry.clone(), material.clone());
                const child1 = new MASSIV.Mesh(geometry.clone(), material.clone());
                const child2 = new MASSIV.Mesh(geometry.clone(), material.clone());
                const child3 = new MASSIV.Mesh(geometry.clone(), material.clone());
                const child1_child1 = new MASSIV.Mesh(geometry.clone(), material.clone());
                const child1_child2 = new MASSIV.Mesh(geometry.clone(), material.clone());
                const child1_child3 = new MASSIV.Mesh(geometry.clone(), material.clone());
                const child1_child3_child1 = new MASSIV.Mesh(geometry.clone(), material.clone());

                child1_child3.addChild(child1_child3_child1);

                child1.addChild(child1_child1);
                child1.addChild(child1_child2);
                child1.addChild(child1_child3);

                rootNode.addChild(child1);
                rootNode.addChild(child2);
                rootNode.addChild(child3);

                child1.translate(2, 0, 0);
                child2.translate(-2, 0, 0);
                child3.translate(-4, 0, 0);

                child1_child1.translate(2, 0, -2);
                child1_child2.translate(2, 0, 2);
                child1_child3.translate(2, 0, 4);

                child1_child3_child1.translate(2, 2, 0);

                const scene = new MASSIV.Scene();
                scene.addChild(camera);
                scene.addChild(rootNode);
                scene.setActiveCamera(camera);

                window.addEventListener('resize', () => {
                    camera.updateProjectionMatrix(45, domNode.clientWidth / domNode.clientHeight, 0.1, 1000);
                    renderer.resize();
                    renderer.render(scene);
                });

                let then = 0;
                let oneSecond = Date.now() + 1000;
                let fps = 0;

                let frameTimes = [];

                const update = () => {
                    requestAnimationFrame(update);
                    const before = Date.now();
                    fps++;

                    rootNode.rotate(0, 1, 0);
                    child1.rotate(1, 0, 0);
                    child1_child3.rotate(0, 0, 1);
                    child1_child3_child1.rotate(2, 0, 0);
                    renderer.render(scene);

                    const after = Date.now();
                    frameTimes.push(after - before);

                    const currentTime = Date.now();
                    if (currentTime >= oneSecond) {
                        const w = domNode.clientWidth;
                        const h = domNode.clientHeight;
                        const averageFrameTime = frameTimes.reduce((accum, val) => accum + val, 0) / frameTimes.length;
                        fpsCounter.textContent = `FPS: ${fps} | AVG Frametime: ${averageFrameTime.toFixed(2)}ms | Screen: ${w}/${h}`;
                        fps = 0;
                        oneSecond = currentTime + 1000;
                    }
                };

                requestAnimationFrame(update);
            })();
        </script>
    </body>
</html>
