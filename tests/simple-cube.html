<!doctype html>
<html lang="de">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>simple-cube</title>
        <style type="text/css">
            #container {
                position: fixed;
                top: 0px;
                left: 0px;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
        </style>
    </head>

    <body>
        <div id="container"></div>
        <script src="massiv-3d.js"></script>
        <script src="assets/cube.js"></script>
        <script type="text/javascript">
            (async () => {
                const domNode = document.getElementById('container');
                const [img, img2] = await Promise.all([
                    MASSIV.ImageLoader.load('assets/cube-texture.png'),
                    MASSIV.ImageLoader.load('assets/cube-texture-2.jpg'),
                ]);

                const { positions, normals, uvs, indices } = Cube;
                const geometry1 = new MASSIV.Geometry({ positions, normals, uvs });
                const material1 = new MASSIV.BlinnPhongMaterial({ indices, diffuseTexture: img });
                const mesh1 = new MASSIV.Mesh({ geometry: geometry1, materials: [material1] });

                const geometry2 = new MASSIV.Geometry({ positions, normals, uvs });
                const material2 = new MASSIV.BlinnPhongMaterial({ indices, diffuseTexture: img2 });
                const mesh2 = new MASSIV.Mesh({ geometry: geometry2, materials: [material2] });

                mesh1.translate(-3, 0, 0);
                mesh2.translate(3, 0, 0);

                const w = domNode.clientWidth;
                const h = domNode.clientHeight;
                
                const camera = new MASSIV.PerspectiveCamera(45 * Math.PI / 180, w / h, 0.1, 100);
                camera.translate(0, 5, 10);
                camera.lookAt(0, 0, 0);
                camera.computeModelMatrix();

                const scene = new MASSIV.Scene();
                scene.addChild(mesh1);
                scene.addChild(mesh2);

                const renderer = new MASSIV.WebGLRenderer(domNode, scene, camera);
                renderer.init();
                renderer.render();

                window.addEventListener('resize', (e) => {                    
                    const nw = domNode.clientWidth;
                    const nh = domNode.clientHeight;
                    renderer.resize();
                    camera.updateProjectionMatrix(45 * Math.PI / 180, nw / nh, 0.1, 100);
                });

                let then = 0;
                let oneSecond = Date.now() + 1000;
                let fps = 0;

                let rotation = 20;

                const tick = (now) => {
                    now *= 0.001;
                    const delta = now - then;
                    then = now;

                    fps++;

                    const currentTime = Date.now();
                    if (currentTime >= oneSecond) {
                        console.log('called ', {fps});
                        fps = 0;
                        oneSecond = currentTime + 1000;
                    }

                    mesh1.rotate(rotation * delta, 0, rotation * delta);
                    mesh2.rotate(rotation * delta, rotation * delta, 0);
                    scene.rotate(0, rotation * delta, 0);
                    renderer.render();

                    requestAnimationFrame(tick);
                };

                requestAnimationFrame(tick);
            })();
        </script>
    </body>
</html>
